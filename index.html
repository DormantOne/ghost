<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Ghost RPS - Bluetooth</title>
    <script src="https://cdn.jsdelivr.net/npm/qrious/dist/qrious.min.js"></script>
    <style>
        body {
            font-family: 'Courier New', monospace;
            background: #000;
            color: #0f0;
            text-align: center;
            padding: 20px;
            margin: 0;
        }
        
        h1 { text-shadow: 0 0 10px #0f0; margin-bottom: 5px; }
        .sub { color: #666; font-size: 12px; margin-bottom: 30px; }
        
        .btn {
            background: transparent;
            border: 2px solid #0f0;
            color: #0f0;
            padding: 15px 30px;
            font-family: inherit;
            font-size: 16px;
            cursor: pointer;
            margin: 10px;
            text-transform: uppercase;
        }
        
        .btn:hover { background: #0f0; color: #000; }
        .btn:disabled { opacity: 0.3; border-color: #333; color: #333; }
        .btn.secondary { border-color: #666; color: #666; font-size: 12px; }
        
        canvas { margin: 20px auto; display: block; background: white; padding: 10px; }
        
        .panel {
            border: 1px solid #0f0;
            padding: 20px;
            margin: 20px auto;
            max-width: 400px;
            display: none;
        }
        
        .panel.active { display: block; }
        
        .code-display {
            font-size: 48px;
            letter-spacing: 10px;
            color: #ff0;
            text-shadow: 0 0 20px #ff0;
            margin: 20px 0;
            font-weight: bold;
        }
        
        .bt-scanning {
            animation: scan 2s infinite;
        }
        
        @keyframes scan {
            0%, 100% { box-shadow: 0 0 5px #0f0; }
            50% { box-shadow: 0 0 30px #0f0, inset 0 0 20px #0f0; }
        }
        
        input[type="text"] {
            background: #000;
            border: 1px solid #0f0;
            color: #0f0;
            padding: 15px;
            font-size: 24px;
            text-align: center;
            letter-spacing: 5px;
            width: 200px;
            text-transform: uppercase;
            font-family: inherit;
        }
        
        .device-list {
            margin: 20px 0;
            text-align: left;
        }
        
        .device-item {
            border: 1px solid #0f0;
            padding: 15px;
            margin: 10px 0;
            cursor: pointer;
            background: rgba(0, 20, 0, 0.3);
            transition: all 0.2s;
        }
        
        .device-item:hover {
            background: rgba(0, 255, 0, 0.2);
            transform: translateX(10px);
        }
        
        .rssi {
            float: right;
            color: #888;
            font-size: 12px;
        }
        
        #game { display: none; max-width: 500px; margin: 0 auto; }
        
        .choices {
            display: flex;
            justify-content: center;
            gap: 20px;
            margin: 40px 0;
        }
        
        .choice {
            width: 80px;
            height: 80px;
            border: 2px solid #0f0;
            font-size: 40px;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            background: rgba(0, 50, 0, 0.3);
        }
        
        .choice:hover:not(.disabled) {
            transform: scale(1.1);
            background: rgba(0, 255, 0, 0.2);
            box-shadow: 0 0 20px #0f0;
        }
        
        .choice.disabled { opacity: 0.3; pointer-events: none; }
        .choice.selected { background: #0f0; color: #000; }
        
        .score {
            font-size: 32px;
            margin: 20px 0;
            display: flex;
            justify-content: space-around;
        }
        
        .log {
            font-size: 11px;
            opacity: 0.7;
            margin-top: 20px;
            border-top: 1px solid #003300;
            padding-top: 10px;
        }
        
        .note {
            color: #666;
            font-size: 11px;
            margin-top: 10px;
        }
    </style>
</head>
<body>

    <h1>◢ GHOST RPS ◣</h1>
    <div class="sub">Bluetooth Low Energy // Web App</div>

    <div id="setup">
        <!-- Step 1: Show QR for phone to get URL -->
        <div id="qr-step">
            <p>Scan with phone to open:</p>
            <canvas id="url-qr"></canvas>
            <p class="note">Or visit: <span id="current-url"></span></p>
            <br>
            <button class="btn" onclick="showHostPanel()">I'm Host (Computer)</button>
            <button class="btn" onclick="showJoinPanel()">I'm Joiner (Phone)</button>
        </div>

        <!-- Host: Create Game Code -->
        <div id="host-panel" class="panel">
            <h3>Your Game Code</h3>
            <div class="code-display" id="host-code">----</div>
            <p>Tell opponent this code or wait for Bluetooth scan...</p>
            <button class="btn bt-scanning" id="advertise-btn" onclick="startBluetoothServer()">Broadcast via BLE</button>
            <p class="note">Chrome/Android only. Alternative: Just shout the code!</p>
        </div>

        <!-- Joiner: Enter Code or Scan BT -->
        <div id="join-panel" class="panel">
            <h3>Enter Code from Host</h3>
            <input type="text" id="join-code" maxlength="4" placeholder="ABCD">
            <br><br>
            <button class="btn" onclick="joinByCode()">Connect via Code</button>
            <br><br>
            <button class="btn secondary" onclick="scanBluetooth()">Or Scan Bluetooth</button>
            <div id="bt-devices" class="device-list"></div>
        </div>
    </div>

    <!-- Game -->
    <div id="game">
        <div class="score">
            <div>YOU: <span id="my-score">0</span></div>
            <div>FOE: <span id="foe-score">0</span></div>
        </div>
        <div id="message" style="font-size: 20px; margin: 20px;">Choose!</div>
        
        <div class="choices">
            <div class="choice" onclick="play('rock')">✊</div>
            <div class="choice" onclick="play('paper')">✋</div>
            <div class="choice" onclick="play('scissors')">✌</div>
        </div>
        
        <div id="foe-move" style="font-size: 60px; opacity: 0.3; height: 80px;">?</div>
        
        <button class="btn secondary" onclick="location.reload()" style="margin-top: 30px;">Disconnect</button>
        <div class="log" id="log"></div>
    </div>

    <script>
        // Generate simple URL QR on load
        const currentUrl = window.location.href.split('#')[0];
        document.getElementById('current-url').textContent = currentUrl;
        
        new QRious({
            element: document.getElementById('url-qr'),
            value: currentUrl,
            size: 200
        });

        // Game State
        let myScore = 0;
        let foeScore = 0;
        let myChoice = null;
        let foeChoice = null;
        let roundActive = false;
        let gameCode = '';
        let isHost = false;
        let btDevice = null;
        let btServer = null;
        let btChar = null;

        // UTILS
        function log(msg) {
            document.getElementById('log').innerHTML += '> ' + msg + '<br>';
            console.log(msg);
        }

        function generateCode() {
            return Math.random().toString(36).substring(2, 6).toUpperCase();
        }

        // HOST FLOW
        function showHostPanel() {
            document.getElementById('qr-step').style.display = 'none';
            document.getElementById('host-panel').classList.add('active');
            gameCode = generateCode();
            document.getElementById('host-code').textContent = gameCode;
            isHost = true;
            
            // Setup "fake" Bluetooth server (Web Bluetooth limitation workaround)
            // Actually using BroadcastChannel for same-device tab communication 
            // or just waiting for code entry
            setupHostChannel();
        }

        function setupHostChannel() {
            // Use localStorage polling as fallback since Web Bluetooth can't really host
            window.addEventListener('storage', (e) => {
                if (e.key === 'ghost-move-' + gameCode) {
                    const data = JSON.parse(e.newValue);
                    handleFoeMove(data.move);
                }
            });
        }

        async function startBluetoothServer() {
            // Note: Web Bluetooth cannot act as peripheral/server in standard browsers
            // This attempts to use the device name as the broadcast method
            alert('Web Bluetooth can only scan, not host.\nJust tell them the code: ' + gameCode);
        }

        // JOINER FLOW
        function showJoinPanel() {
            document.getElementById('qr-step').style.display = 'none';
            document.getElementById('join-panel').classList.add('active');
        }

        function joinByCode() {
            const code = document.getElementById('join-code').value.toUpperCase();
            if (code.length !== 4) return alert('Enter 4-letter code!');
            gameCode = code;
            startGame();
        }

        async function scanBluetooth() {
            if (!navigator.bluetooth) {
                alert('Web Bluetooth not supported. Use the code instead!');
                return;
            }

            try {
                log('Scanning for BLE devices...');
                const device = await navigator.bluetooth.requestDevice({
                    acceptAllDevices: true,
                    optionalServices: ['battery_service'] // Generic services
                });
                
                log('Found: ' + device.name);
                btDevice = device;
                
                // Show in list
                const div = document.createElement('div');
                div.className = 'device-item';
                div.innerHTML = `<span>${device.name || 'Unknown'}</span><span class="rssi">Connect</span>`;
                div.onclick = () => connectToDevice(device);
                document.getElementById('bt-devices').appendChild(div);
                
            } catch (e) {
                log('Scan cancelled or failed');
            }
        }

        async function connectToDevice(device) {
            try {
                log('Connecting to ' + device.name + '...');
                btServer = await device.gatt.connect();
                log('Connected! Starting game...');
                
                // In a real BLE RPS, we'd exchange characteristics here
                // For web simplicity, we use the code method for actual game data
                startGame();
            } catch (e) {
                log('Connection failed: ' + e.message);
            }
        }

        // GAME LOGIC (uses localStorage as "Bluetooth" fallback)
        function startGame() {
            document.getElementById('setup').style.display = 'none';
            document.getElementById('game').style.display = 'block';
            log('Connected via code: ' + gameCode);
        }

        function play(move) {
            if (roundActive) return;
            roundActive = true;
            myChoice = move;
            
            // Visuals
            const choices = document.querySelectorAll('.choice');
            choices.forEach(c => c.classList.add('disabled'));
            event.target.classList.remove('disabled');
            event.target.classList.add('selected');
            document.getElementById('message').textContent = 'Waiting...';
            
            // Send move (via storage for cross-tab/fallback)
            const moveData = { move: move, timestamp: Date.now() };
            localStorage.setItem('ghost-move-' + gameCode, JSON.stringify(moveData));
            
            // Simulate opponent (if testing alone) or wait for real opponent
            if (!isHost) {
                // If joiner, wait for host response via different key
                window.addEventListener('storage', function hostResponse(e) {
                    if (e.key === 'ghost-response-' + gameCode) {
                        window.removeEventListener('storage', hostResponse);
                        const data = JSON.parse(e.newValue);
                        handleFoeMove(data.move);
                    }
                });
                
                // Simulate if testing
                setTimeout(() => {
                    if (!foeChoice) {
                        const moves = ['rock', 'paper', 'scissors'];
                        handleFoeMove(moves[Math.floor(Math.random() * 3)]);
                    }
                }, 2000);
            } else {
                // Host waits for joiner move then responds
                window.addEventListener('storage', function joinerMove(e) {
                    if (e.key === 'ghost-move-' + gameCode) {
                        // Echo back for testing or get from storage
                        // Real implementation would be more complex
                    }
                });
            }
        }

        function handleFoeMove(move) {
            foeChoice = move;
            document.getElementById('foe-move').textContent = 
                move === 'rock' ? '✊' : move === 'paper' ? '✋' : '✌';
            document.getElementById('foe-move').style.opacity = '1';
            
            resolveRound();
        }

        function resolveRound() {
            const msg = document.getElementById('message');
            
            if (myChoice === foeChoice) {
                msg.textContent = 'DRAW!';
                msg.style.color = '#ff0';
            } else if (
                (myChoice === 'rock' && foeChoice === 'scissors') ||
                (myChoice === 'paper' && foeChoice === 'rock') ||
                (myChoice === 'scissors' && foeChoice === 'paper')
            ) {
                myScore++;
                msg.textContent = 'YOU WIN!';
                msg.style.color = '#0f0';
            } else {
                foeScore++;
                msg.textContent = 'YOU LOSE!';
                msg.style.color = '#f00';
            }
            
            document.getElementById('my-score').textContent = myScore;
            document.getElementById('foe-score').textContent = foeScore;
            
            setTimeout(() => {
                myChoice = null;
                foeChoice = null;
                roundActive = false;
                document.querySelectorAll('.choice').forEach(c => {
                    c.classList.remove('disabled', 'selected');
                });
                document.getElementById('foe-move').textContent = '?';
                document.getElementById('foe-move').style.opacity = '0.3';
                msg.textContent = 'Choose!';
                msg.style.color = '#0f0';
            }, 3000);
        }
    </script>
</body>
</html>
