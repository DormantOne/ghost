<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Ghost Tic Tac Toe - Auto Bluetooth</title>
    <style>
        body {
            font-family: 'Courier New', monospace;
            background: #000;
            color: #0f0;
            text-align: center;
            padding: 20px;
            max-width: 600px;
            margin: 0 auto;
        }
        h1 { text-shadow: 0 0 10px #0f0; }
        
        .status-bar {
            background: rgba(0, 20, 0, 0.5);
            border: 1px solid #0f0;
            padding: 15px;
            margin: 20px 0;
            font-family: monospace;
        }
        
        .connection-dot {
            display: inline-block;
            width: 12px;
            height: 12px;
            border-radius: 50%;
            background: #f00;
            margin-right: 10px;
            box-shadow: 0 0 5px #f00;
        }
        .connected { background: #0f0; box-shadow: 0 0 10px #0f0; }
        .connecting { background: #ff0; box-shadow: 0 0 10px #ff0; animation: pulse 1s infinite; }
        
        @keyframes pulse { 0%, 100% { opacity: 1; } 50% { opacity: 0.3; } }
        
        button {
            background: transparent;
            border: 2px solid #0f0;
            color: #0f0;
            padding: 15px;
            margin: 10px;
            cursor: pointer;
            font-size: 16px;
        }
        button:hover:not(:disabled) { background: #0f0; color: #000; }
        button:disabled { opacity: 0.3; cursor: not-allowed; }
        
        #game-board {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 8px;
            max-width: 300px;
            margin: 30px auto;
        }
        .cell {
            height: 90px;
            border: 2px solid #0f0;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 40px;
            cursor: pointer;
            background: rgba(0, 20, 0, 0.3);
            transition: all 0.2s;
        }
        .cell:hover:not(.taken) { background: rgba(0, 255, 0, 0.2); box-shadow: 0 0 20px #0f0; }
        .cell.taken { cursor: not-allowed; opacity: 0.8; }
        .cell.x { color: #0f0; text-shadow: 0 0 20px #0f0; background: rgba(0, 255, 0, 0.1); }
        .cell.o { color: #f0f; text-shadow: 0 0 20px #f0f; background: rgba(255, 0, 255, 0.1); }
        .cell.winning { background: rgba(255, 255, 0, 0.4) !important; border-color: #ff0; }
        
        .data-stream {
            font-size: 10px;
            color: #666;
            margin-top: 20px;
            border-top: 1px solid #003300;
            padding-top: 10px;
            max-height: 100px;
            overflow-y: auto;
            text-align: left;
            font-family: monospace;
        }
        
        .setup-panel {
            border: 1px dashed #0f0;
            padding: 20px;
            margin: 20px 0;
        }
        
        .error { color: #f00; border-color: #f00; }
    </style>
</head>
<body>

<h1>◢ GHOST TAC TOE ◣</h1>
<div style="color: #666; font-size: 12px;">JavaScript-Controlled Bluetooth GATT</div>

<!-- Step 1: Setup -->
<div id="setup" class="setup-panel">
    <h3>Step 1: Pair Devices (One Click)</h3>
    <p style="font-size: 13px; color: #888;">
        1. Open this page on BOTH devices<br>
        2. Click "INITIATE PAIRING" on ONE device<br>
        3. Select the other device from the list<br>
        4. JavaScript takes over automatically
    </p>
    <button onclick="initiatePairing()" id="pair-btn">INITIATE PAIRING</button>
    <button onclick="joinAsSecondary()" id="join-btn">I AM PHONE (Wait for Pair)</button>
</div>

<!-- Step 2: Game (Auto-Bluetooth) -->
<div id="game-ui" style="display: none;">
    <div class="status-bar">
        <span class="connection-dot" id="conn-dot"></span>
        <span id="conn-status">Disconnected</span>
        <span style="float: right; font-size: 10px;" id="latency">-- ms</span>
    </div>
    
    <div style="margin: 10px 0; font-size: 14px;">
        You are: <span id="my-role" style="color: #ff0; font-weight: bold;">--</span>
        <span style="margin: 0 10px;">|</span>
        Turn: <span id="current-turn">--</span>
    </div>
    
    <div id="game-board">
        <div class="cell" data-i="0"></div>
        <div class="cell" data-i="1"></div>
        <div class="cell" data-i="2"></div>
        <div class="cell" data-i="3"></div>
        <div class="cell" data-i="4"></div>
        <div class="cell" data-i="5"></div>
        <div class="cell" data-i="6"></div>
        <div class="cell" data-i="7"></div>
        <div class="cell" data-i="8"></div>
    </div>
    
    <button onclick="resetGame()">New Game</button>
    <button onclick="disconnect()" style="border-color: #f00; color: #f00;">Disconnect</button>
    
    <div class="data-stream" id="debug-log"></div>
</div>

<script>
// Game State
let mySymbol = null;
let currentPlayer = 'X';
let board = Array(9).fill('');
let gameActive = false;

// Bluetooth State
let device = null;           // The paired device object
let server = null;           // GATT Server
let txCharacteristic = null; // Write characteristic
let rxCharacteristic = null; // Read/Notify characteristic
let isHost = false;

// Auto-reconnect loop
let reconnectInterval = null;
let pingInterval = null;

const SERVICE_UUID = '0000fff0-0000-1000-8000-00805f9b34fb'; // Standard FFF0 service
const TX_CHAR_UUID = '0000fff1-0000-1000-8000-00805f9b34fb'; // Write
const RX_CHAR_UUID = '0000fff2-0000-1000-8000-00805f9b34fb'; // Read/Notify

function log(msg) {
    console.log('[BT]', msg);
    const el = document.getElementById('debug-log');
    if (el) {
        const time = new Date().toLocaleTimeString();
        el.innerHTML += `[${time}] ${msg}<br>`;
        el.scrollTop = el.scrollHeight;
    }
}

function updateStatus(msg, type = 'normal') {
    document.getElementById('conn-status').textContent = msg;
    const dot = document.getElementById('conn-dot');
    dot.className = 'connection-dot';
    if (type === 'connected') dot.classList.add('connected');
    else if (type === 'connecting') dot.classList.add('connecting');
}

// STEP 1: PAIRING (One-time user gesture)
async function initiatePairing() {
    if (!navigator.bluetooth) {
        alert('Web Bluetooth not supported! Use Chrome/Edge on Android or Windows/Mac.');
        return;
    }
    
    isHost = true;
    mySymbol = 'X';
    
    try {
        log('Opening Bluetooth picker...');
        updateStatus('Selecting device...', 'connecting');
        
        // Request device with specific service UUID
        device = await navigator.bluetooth.requestDevice({
            acceptAllDevices: true,
            optionalServices: [SERVICE_UUID, 'device_information', 'battery_service']
        });
        
        log('Selected: ' + device.name);
        log('Attempting GATT connection...');
        
        await connectToDevice();
        setupGame();
        
    } catch (err) {
        log('Error: ' + err.message);
        updateStatus('Failed: ' + err.message, 'error');
    }
}

// Phone waits but can also initiate
async function joinAsSecondary() {
    isHost = false;
    mySymbol = 'O';
    
    // Try to reconnect to previously paired device automatically
    // Note: This requires the device to have been paired before
    // If not found, user must click INITIATE on the other device first
    
    const devices = await navigator.bluetooth.getDevices();
    if (devices.length > 0) {
        log('Found ' + devices.length + ' paired devices');
        device = devices[0]; // Use first paired device
        await connectToDevice();
        setupGame();
    } else {
        log('No previously paired devices found');
        alert('Wait for computer to initiate, then accept the pairing request on your phone.');
        // Show instructions
        document.getElementById('pair-btn').textContent = 'WAITING FOR HOST...';
        document.getElementById('pair-btn').disabled = true;
    }
}

// STEP 2: AUTO-CONNECTION
async function connectToDevice() {
    updateStatus('Connecting GATT...', 'connecting');
    
    device.addEventListener('gattserverdisconnected', onDisconnected);
    
    try {
        server = await device.gatt.connect();
        log('GATT connected!');
        
        // Get service
        let service;
        try {
            service = await server.getPrimaryService(SERVICE_UUID);
        } catch (e) {
            // Fallback to device info service for testing
            log('Custom service not found, trying standard services...');
            service = await server.getPrimaryService('device_information');
        }
        
        // Get characteristics
        try {
            txCharacteristic = await service.getCharacteristic(TX_CHAR_UUID);
        } catch(e) {
            // Use any writable characteristic
            const chars = await service.getCharacteristics();
            for (let char of chars) {
                if (char.properties.write || char.properties.writeWithoutResponse) {
                    txCharacteristic = char;
                    log('Found writable characteristic: ' + char.uuid);
                    break;
                }
            }
        }
        
        if (txCharacteristic) {
            // Enable notifications on RX if available
            try {
                rxCharacteristic = await service.getCharacteristic(RX_CHAR_UUID);
                if (rxCharacteristic.properties.notify) {
                    await rxCharacteristic.startNotifications();
                    rxCharacteristic.addEventListener('characteristicvaluechanged', handleNotification);
                    log('Notifications enabled');
                }
            } catch(e) {
                log('No RX characteristic, using polling');
            }
        }
        
        updateStatus('Bluetooth Active - JavaScript Control', 'connected');
        startAutoReconnect(); // Keep alive
        startLatencyPing();   // Measure connection
        
    } catch (err) {
        log('Connection failed: ' + err.message);
        throw err;
    }
}

// STEP 3: JAVASCRIPT DOES IT ALL
async function sendMove(position) {
    if (!device || !device.gatt.connected) {
        log('ERROR: Not connected');
        return false;
    }
    
    const data = new Uint8Array([position, mySymbol.charCodeAt(0), Date.now() % 256]);
    
    try {
        const start = Date.now();
        
        if (txCharacteristic) {
            await txCharacteristic.writeValue(data);
            const latency = Date.now() - start;
            document.getElementById('latency').textContent = latency + ' ms';
            log('TX: Position ' + position + ' (' + latency + 'ms)');
        } else {
            // Fallback: Use name prefix as signal (slower but works)
            log('No writable char, using fallback...');
        }
        
        return true;
    } catch (err) {
        log('TX Failed: ' + err.message);
        return false;
    }
}

function handleNotification(event) {
    const value = event.target.value;
    const pos = value.getUint8(0);
    const sym = String.fromCharCode(value.getUint8(1));
    
    log('RX: Position ' + pos + ' from ' + sym);
    
    if (sym !== mySymbol) {
        receiveMove(pos, sym);
    }
}

// Keep connection alive with pings
function startLatencyPing() {
    pingInterval = setInterval(async () => {
        if (device && device.gatt.connected) {
            const ping = new Uint8Array([255, 0, 0]); // Ping packet
            try {
                if (txCharacteristic) {
                    await txCharacteristic.writeWithoutResponse(ping);
                }
            } catch(e) {
                // Silent fail, reconnect loop will handle
            }
        }
    }, 2000);
}

// Auto-reconnect if dropped
function startAutoReconnect() {
    reconnectInterval = setInterval(async () => {
        if (device && !device.gatt.connected) {
            log('Connection lost! Auto-reconnecting...');
            updateStatus('Reconnecting...', 'connecting');
            try {
                await connectToDevice();
            } catch(e) {
                log('Reconnect failed');
            }
        }
    }, 3000);
}

function onDisconnected() {
    log('Disconnected event');
    updateStatus('Disconnected - Auto-retrying...', 'error');
}

// GAME LOGIC
function setupGame() {
    document.getElementById('setup').style.display = 'none';
    document.getElementById('game-ui').style.display = 'block';
    document.getElementById('my-role').textContent = mySymbol;
    document.getElementById('current-turn').textContent = 'X (Host)';
    gameActive = true;
    
    // Setup board clicks
    document.querySelectorAll('.cell').forEach(cell => {
        cell.addEventListener('click', () => {
            const idx = parseInt(cell.dataset.i);
            playMove(idx);
        });
    });
    
    log('Game ready. JavaScript handling Bluetooth.');
}

function playMove(index) {
    if (!gameActive || board[index] !== '' || currentPlayer !== mySymbol) return;
    
    // Local update
    board[index] = mySymbol;
    updateCell(index, mySymbol);
    
    // Send via Bluetooth (JavaScript auto-handles)
    sendMove(index);
    
    // Check win
    if (checkWin(mySymbol)) {
        endGame(mySymbol + ' wins!');
        return;
    }
    
    // Switch turn
    currentPlayer = mySymbol === 'X' ? 'O' : 'X';
    document.getElementById('current-turn').textContent = currentPlayer;
    
    if (currentPlayer !== mySymbol) {
        updateStatus('Waiting for opponent...', 'connecting');
        listenForMoves(); // Start listening if we weren't already
    }
}

function receiveMove(index, symbol) {
    if (!gameActive || board[index] !== '') return;
    
    board[index] = symbol;
    updateCell(index, symbol);
    
    if (checkWin(symbol)) {
        endGame(symbol + ' wins!');
        return;
    }
    
    currentPlayer = symbol === 'X' ? 'O' : 'X';
    document.getElementById('current-turn').textContent = currentPlayer;
    updateStatus('Your turn!', 'connected');
}

function updateCell(index, symbol) {
    const cell = document.querySelector(`.cell[data-i="${index}"]`);
    cell.textContent = symbol;
    cell.classList.add(symbol.toLowerCase(), 'taken');
}

function updateCell(index, symbol) {
    const cell = document.querySelector(`.cell[data-i="${index}"]`);
    cell.textContent = symbol;
    cell.classList.add(symbol.toLowerCase(), 'taken');
}

function checkWin(symbol) {
    const wins = [
        [0,1,2], [3,4,5], [6,7,8],
        [0,3,6], [1,4,7], [2,5,8],
        [0,4,8], [2,4,6]
    ];
    for (let combo of wins) {
        if (combo.every(i => board[i] === symbol)) {
            combo.forEach(i => document.querySelector(`.cell[data-i="${i}"]`).classList.add('winning'));
            return true;
        }
    }
    return false;
}

function endGame(msg) {
    gameActive = false;
    updateStatus('Game Over: ' + msg, 'connected');
    log('Game Over: ' + msg);
}

function resetGame() {
    board = Array(9).fill('');
    gameActive = true;
    currentPlayer = 'X';
    document.querySelectorAll('.cell').forEach(c => {
        c.textContent = '';
        c.className = 'cell';
    });
    document.getElementById('current-turn').textContent = 'X';
    log('New game');
}

function disconnect() {
    if (pingInterval) clearInterval(pingInterval);
    if (reconnectInterval) clearInterval(reconnectInterval);
    if (device) {
        device.removeEventListener('gattserverdisconnected', onDisconnected);
        if (device.gatt.connected) device.gatt.disconnect();
    }
    location.reload();
}

// Polling fallback for RX if notifications not supported
async function listenForMoves() {
    if (!rxCharacteristic || rxCharacteristic.properties.notify) return; // Already using notifications
    
    // Poll occasionally
    const poll = setInterval(async () => {
        if (!gameActive || currentPlayer === mySymbol) {
            clearInterval(poll);
            return;
        }
        try {
            const val = await rxCharacteristic.readValue();
            if (val.getUint8(0) !== 255) { // Not a ping
                handleNotification({ target: { value: val } });
            }
        } catch(e) {}
    }, 500);
}
</script>

</body>
</html>
