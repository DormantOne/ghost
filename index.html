<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AnyDevice RPS</title>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body {
            background: #0a0a0a;
            color: #0f0;
            font-family: 'Courier New', monospace;
            min-height: 100vh;
            padding: 20px;
            text-align: center;
        }
        .btn {
            background: transparent;
            border: 2px solid #0f0;
            color: #0f0;
            padding: 15px 30px;
            font-family: inherit;
            font-size: 16px;
            cursor: pointer;
            margin: 10px;
            text-transform: uppercase;
        }
        .btn:hover {
            background: #0f0;
            color: #000;
        }
        .btn:disabled {
            border-color: #333;
            color: #333;
            cursor: not-allowed;
        }
        .hidden { display: none !important; }
        
        #qrcode {
            margin: 20px auto;
            padding: 20px;
            background: white;
            display: inline-block;
            border: 3px solid #0f0;
        }
        
        .code-box {
            width: 100%;
            max-width: 400px;
            margin: 10px auto;
            padding: 15px;
            background: #000;
            border: 1px solid #0f0;
            color: #0f0;
            font-family: monospace;
            font-size: 11px;
            word-break: break-all;
            cursor: pointer;
        }
        
        .section {
            margin: 30px 0;
            padding: 20px;
            border: 1px dashed #0f0;
        }
        
        #game-panel {
            display: none;
            max-width: 600px;
            margin: 0 auto;
        }
        
        .choices {
            display: flex;
            justify-content: center;
            gap: 20px;
            margin: 30px 0;
        }
        
        .choice {
            width: 80px;
            height: 80px;
            border: 2px solid #0f0;
            background: rgba(0, 20, 0, 0.5);
            color: #0f0;
            font-size: 40px;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            user-select: none;
        }
        
        .choice:hover:not(.disabled) {
            background: rgba(0, 255, 0, 0.2);
            transform: scale(1.1);
        }
        
        .choice.disabled {
            opacity: 0.3;
            pointer-events: none;
        }
        
        .choice.selected {
            background: #0f0;
            color: #000;
        }
        
        .score-board {
            font-size: 32px;
            margin: 20px 0;
            display: flex;
            justify-content: center;
            gap: 40px;
        }
        
        #status {
            margin: 20px 0;
            padding: 10px;
            border: 1px solid #0f0;
            min-height: 50px;
        }
        
        .error { color: #f00; border-color: #f00; }
        .success { color: #0f0; background: rgba(0, 255, 0, 0.1); }
        
        video {
            width: 100%;
            max-width: 400px;
            border: 2px solid #0f0;
            margin: 10px 0;
        }
    </style>
</head>
<body>
    <h1>◢ ANYDEVICE RPS ◣</h1>
    <div id="status">Ready</div>

    <div id="setup">
        <button class="btn" onclick="hostGame()">CREATE GAME (Host)</button>
        <button class="btn" onclick="showJoin()">JOIN GAME (Scan)</button>
        
        <!-- Host Panel -->
        <div id="host-panel" class="section hidden">
            <h3>Scan with phone or copy code:</h3>
            <div id="qrcode">Generating...</div>
            <div style="margin-top: 10px; font-size: 12px; color: #888;">Or copy this text:</div>
            <div id="offer-code" class="code-box" onclick="copyToClipboard(this)">Generating...</div>
            
            <div id="answer-section" class="hidden" style="margin-top: 20px;">
                <h3>Paste response from phone:</h3>
                <textarea id="answer-input" class="code-box" style="height: 100px;" placeholder="Paste code here..."></textarea>
                <button class="btn" onclick="submitAnswer()">CONNECT</button>
            </div>
        </div>
        
        <!-- Join Panel -->
        <div id="join-panel" class="section hidden">
            <button class="btn" onclick="startCamera()">Scan QR with Camera</button>
            <button class="btn" onclick="showManualJoin()">Paste Code Instead</button>
            
            <div id="camera-area" class="hidden">
                <video id="video" playsinline></video>
                <canvas id="canvas" style="display: none;"></canvas>
                <div style="font-size: 12px; margin-top: 5px;">Point camera at QR code</div>
            </div>
            
            <div id="manual-join" class="hidden" style="margin-top: 20px;">
                <textarea id="join-input" class="code-box" style="height: 100px;" placeholder="Paste host code here..."></textarea>
                <button class="btn" onclick="createAnswer()">CONNECT</button>
            </div>
            
            <div id="answer-display" class="hidden" style="margin-top: 20px;">
                <h3>Show this to host:</h3>
                <div id="answer-qrcode"></div>
                <div class="code-box" id="answer-code" onclick="copyToClipboard(this)"></div>
            </div>
        </div>
    </div>

    <!-- Game Panel -->
    <div id="game-panel">
        <div class="score-board">
            <div>YOU: <span id="my-score">0</span></div>
            <div>FOE: <span id="foe-score">0</span></div>
        </div>
        <div id="round-status" style="margin: 20px 0; font-size: 24px;">Choose!</div>
        <div class="choices">
            <div class="choice" id="rock" onclick="play('rock')">✊</div>
            <div class="choice" id="paper" onclick="play('paper')">✋</div>
            <div class="choice" id="scissors" onclick="play('scissors')">✌</div>
        </div>
        <div id="foe-move" style="font-size: 60px; height: 80px; margin: 20px 0; opacity: 0.3;">?</div>
        <button class="btn" onclick="location.reload()" style="margin-top: 30px;">RESET</button>
    </div>

    <!-- QRCode Library -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/qrcodejs/1.0.0/qrcode.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/jsqr@1.4.0/dist/jsQR.js"></script>
    
    <script>
        let pc = null;
        let dc = null;
        let isHost = false;
        let myChoice = null;
        let foeChoice = null;
        let myScore = 0;
        let foeScore = 0;
        let roundActive = false;
        
        const status = document.getElementById('status');
        
        function setStatus(msg, type='') {
            status.textContent = msg;
            status.className = type;
            console.log(msg);
        }
        
        // HOST
        async function hostGame() {
            isHost = true;
            document.getElementById('host-panel').classList.remove('hidden');
            document.getElementById('join-panel').classList.add('hidden');
            setStatus('Creating game...');
            
            try {
                pc = new RTCPeerConnection({
                    iceServers: [{ urls: 'stun:stun.l.google.com:19302' }]
                });
                
                dc = pc.createDataChannel('game');
                setupChannel(dc);
                
                pc.onicecandidate = (e) => {
                    if (!e.candidate) {
                        // ICE complete
                        const offer = pc.localDescription;
                        const offerStr = btoa(JSON.stringify(offer));
                        
                        // Show QR
                        document.getElementById('qrcode').innerHTML = '';
                        try {
                            new QRCode(document.getElementById('qrcode'), {
                                text: offerStr,
                                width: 200,
                                height: 200,
                                colorDark: '#000',
                                colorLight: '#fff',
                                correctLevel: QRCode.CorrectLevel.H
                            });
                            setStatus('QR Code ready! Scan with phone.');
                        } catch(err) {
                            document.getElementById('qrcode').textContent = 'QR Error - use text below';
                            setStatus('QR failed, use text code');
                        }
                        
                        document.getElementById('offer-code').textContent = offerStr;
                        document.getElementById('answer-section').classList.remove('hidden');
                    }
                };
                
                const offer = await pc.createOffer();
                await pc.setLocalDescription(offer);
                
            } catch(e) {
                setStatus('Error: ' + e.message, 'error');
                console.error(e);
            }
        }
        
        function submitAnswer() {
            const answerStr = document.getElementById('answer-input').value.trim();
            if (!answerStr) return setStatus('Paste the answer code!', 'error');
            
            try {
                const answer = JSON.parse(atob(answerStr));
                pc.setRemoteDescription(new RTCSessionDescription(answer));
                setStatus('Connected!', 'success');
                startGame();
            } catch(e) {
                setStatus('Invalid code: ' + e.message, 'error');
            }
        }
        
        // JOIN
        function showJoin() {
            document.getElementById('join-panel').classList.remove('hidden');
            document.getElementById('host-panel').classList.add('hidden');
        }
        
        function showManualJoin() {
            document.getElementById('manual-join').classList.remove('hidden');
            document.getElementById('camera-area').classList.add('hidden');
        }
        
        async function startCamera() {
            document.getElementById('camera-area').classList.remove('hidden');
            const video = document.getElementById('video');
            
            try {
                const stream = await navigator.mediaDevices.getUserMedia({ video: { facingMode: 'environment' } });
                video.srcObject = stream;
                video.play();
                setStatus('Camera active - point at QR');
                scanLoop();
            } catch(e) {
                setStatus('Camera failed: ' + e.message, 'error');
                showManualJoin();
            }
        }
        
        function scanLoop() {
            if (!document.getElementById('camera-area').classList.contains('hidden')) {
                const video = document.getElementById('video');
                const canvas = document.getElementById('canvas');
                const ctx = canvas.getContext('2d');
                
                if (video.readyState === video.HAVE_ENOUGH_DATA) {
                    canvas.width = video.videoWidth;
                    canvas.height = video.videoHeight;
                    ctx.drawImage(video, 0, 0, canvas.width, canvas.height);
                    const imgData = ctx.getImageData(0, 0, canvas.width, canvas.height);
                    const code = jsQR(imgData.data, imgData.width, imgData.height);
                    
                    if (code) {
                        handleOffer(code.data);
                        return;
                    }
                }
                requestAnimationFrame(scanLoop);
            }
        }
        
        async function handleOffer(offerStr) {
            setStatus('Processing offer...');
            try {
                pc = new RTCPeerConnection({
                    iceServers: [{ urls: 'stun:stun.l.google.com:19302' }]
                });
                
                pc.ondatachannel = (e) => {
                    dc = e.channel;
                    setupChannel(dc);
                };
                
                pc.onicecandidate = (e) => {
                    if (!e.candidate) {
                        const answer = pc.localDescription;
                        const answerStr = btoa(JSON.stringify(answer));
                        
                        document.getElementById('answer-display').classList.remove('hidden');
                        document.getElementById('answer-code').textContent = answerStr;
                        
                        // Generate answer QR
                        document.getElementById('answer-qrcode').innerHTML = '';
                        try {
                            new QRCode(document.getElementById('answer-qrcode'), {
                                text: answerStr,
                                width: 200,
                                height: 200
                            });
                        } catch(e) {
                            document.getElementById('answer-qrcode').textContent = 'Use text code';
                        }
                        
                        setStatus('Show QR/code to host!');
                    }
                };
                
                const offer = JSON.parse(atob(offerStr));
                await pc.setRemoteDescription(new RTCSessionDescription(offer));
                const answer = await pc.createAnswer();
                await pc.setLocalDescription(answer);
                
            } catch(e) {
                setStatus('Error: ' + e.message, 'error');
            }
        }
        
        function createAnswer() {
            const offerStr = document.getElementById('join-input').value.trim();
            if (!offerStr) return setStatus('Enter the code!', 'error');
            handleOffer(offerStr);
        }
        
        // GAME
        function setupChannel(channel) {
            channel.onopen = () => {
                setStatus('Channel open! Starting...', 'success');
                startGame();
            };
            channel.onmessage = (e) => {
                const data = JSON.parse(e.data);
                if (data.type === 'move') {
                    foeChoice = data.move;
                    resolveRound();
                }
            };
        }
        
        function startGame() {
            document.getElementById('setup').classList.add('hidden');
            document.getElementById('game-panel').style.display = 'block';
        }
        
        function play(move) {
            if (roundActive || !dc || dc.readyState !== 'open') return;
            
            roundActive = true;
            myChoice = move;
            
            document.querySelectorAll('.choice').forEach(c => c.classList.add('disabled'));
            document.getElementById(move).classList.remove('disabled');
            document.getElementById(move).classList.add('selected');
            
            document.getElementById('round-status').textContent = 'Waiting...';
            dc.send(JSON.stringify({ type: 'move', move: move }));
            
            if (foeChoice) resolveRound();
        }
        
        function resolveRound() {
            if (!myChoice || !foeChoice) return;
            
            document.getElementById('foe-move').textContent = 
                foeChoice === 'rock' ? '✊' : foeChoice === 'paper' ? '✋' : '✌';
            document.getElementById('foe-move').style.opacity = '1';
            
            const win = (myChoice === 'rock' && foeChoice === 'scissors') ||
                       (myChoice === 'paper' && foeChoice === 'rock') ||
                       (myChoice === 'scissors' && foeChoice === 'paper');
            const draw = myChoice === foeChoice;
            
            const resultDiv = document.getElementById('round-status');
            if (win) {
                myScore++;
                resultDiv.textContent = 'YOU WIN!';
            } else if (draw) {
                resultDiv.textContent = 'DRAW';
            } else {
                foeScore++;
                resultDiv.textContent = 'YOU LOSE';
            }
            
            document.getElementById('my-score').textContent = myScore;
            document.getElementById('foe-score').textContent = foeScore;
            
            setTimeout(() => {
                myChoice = null;
                foeChoice = null;
                roundActive = false;
                document.querySelectorAll('.choice').forEach(c => {
                    c.classList.remove('disabled', 'selected');
                });
                document.getElementById('foe-move').textContent = '?';
                document.getElementById('foe-move').style.opacity = '0.3';
                document.getElementById('round-status').textContent = 'Choose!';
            }, 3000);
        }
        
        function copyToClipboard(el) {
            navigator.clipboard.writeText(el.textContent).then(() => {
                setStatus('Copied!', 'success');
                setTimeout(() => setStatus('Ready'), 1000);
            });
        }
    </script>
</body>
</html>
