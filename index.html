<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Ghost RPS - https://dormantone.github.io/ghost/</title>
    <script src="https://cdn.jsdelivr.net/npm/qrcode@1.5.3/build/qrcode.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/jsqr@1.4.0/dist/jsQR.js"></script>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body {
            background: #000;
            color: #0f0;
            font-family: 'Courier New', monospace;
            padding: 20px;
            line-height: 1.6;
        }
        h1 { text-align: center; margin-bottom: 10px; font-size: 24px; }
        .url { text-align: center; font-size: 12px; opacity: 0.6; margin-bottom: 30px; }
        
        button {
            background: #001100;
            border: 2px solid #0f0;
            color: #0f0;
            padding: 15px;
            margin: 5px;
            cursor: pointer;
            font-family: inherit;
            font-size: 16px;
            width: 100%;
            max-width: 300px;
            display: block;
            margin-left: auto;
            margin-right: auto;
        }
        button:hover { background: #0f0; color: #000; }
        button:disabled { opacity: 0.3; cursor: not-allowed; }
        
        .panel {
            border: 1px solid #0f0;
            padding: 20px;
            margin: 20px auto;
            max-width: 500px;
            display: none;
        }
        .panel.active { display: block; }
        
        #qrcanvas {
            margin: 20px auto;
            display: block;
            border: 10px solid white;
            background: white;
        }
        
        .code-display {
            background: #001100;
            border: 1px solid #0f0;
            padding: 15px;
            margin: 10px 0;
            font-size: 11px;
            word-break: break-all;
            cursor: pointer;
            user-select: all;
        }
        .code-display:hover { background: #002200; }
        
        textarea {
            width: 100%;
            background: #000;
            border: 1px solid #0f0;
            color: #0f0;
            padding: 10px;
            font-family: inherit;
            margin: 10px 0;
            min-height: 100px;
        }
        
        #game { max-width: 600px; margin: 0 auto; text-align: center; }
        .choices { display: flex; justify-content: center; gap: 20px; margin: 40px 0; }
        .choice {
            width: 100px;
            height: 100px;
            border: 2px solid #0f0;
            font-size: 50px;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            background: rgba(0, 50, 0, 0.3);
        }
        .choice:hover { transform: scale(1.1); background: rgba(0, 255, 0, 0.2); }
        .choice.picked { background: #0f0; color: #000; transform: scale(1.2); }
        .choice:disabled { opacity: 0.3; pointer-events: none; }
        
        .score { font-size: 36px; margin: 20px 0; display: flex; justify-content: space-around; }
        #message { text-align: center; margin: 20px 0; font-size: 20px; height: 30px; }
        #foe-choice { font-size: 60px; text-align: center; height: 80px; margin: 20px 0; opacity: 0.3; }
        
        .big-text { font-size: 14px; margin: 20px 0; color: #ff0; text-align: center; }
        .error { color: #f00; border-color: #f00; }
        .success { color: #0f0; background: rgba(0, 255, 0, 0.1); }
        
        video { width: 100%; max-width: 400px; border: 2px solid #0f0; display: block; margin: 10px auto; }
    </style>
</head>
<body>

<h1>◢ GHOST RPS ◣</h1>
<div class="url">https://dormantone.github.io/ghost/</div>

<div id="setup">
    <p style="text-align: center; margin-bottom: 20px;">
        <strong>Computer vs Phone</strong><br>
        No installs. Direct connection.
    </p>
    
    <button onclick="becomeHost()">1. CREATE GAME (Computer)</button>
    <button onclick="becomeJoiner()">2. JOIN GAME (Phone)</button>
    
    <!-- HOST PANEL -->
    <div id="host-panel" class="panel">
        <div class="big-text">Scan with phone OR copy text:</div>
        
        <canvas id="qrcanvas"></canvas>
        <div id="qr-fallback" style="display: none; color: #f00; text-align: center;">QR Failed - use text below</div>
        
        <div style="margin-top: 20px; font-size: 12px;">CLICK TO COPY:</div>
        <div class="code-display" id="host-code" onclick="copyText(this)">Generating connection code...</div>
        
        <div style="margin-top: 30px; border-top: 1px solid #0f0; padding-top: 20px;">
            <div class="big-text">Paste phone's response here:</div>
            <textarea id="answer-receive" placeholder="Paste the response code from phone..."></textarea>
            <button onclick="completeHost()">START GAME</button>
        </div>
    </div>
    
    <!-- JOINER PANEL -->
    <div id="joiner-panel" class="panel">
        <button onclick="startCamera()">Scan QR Code</button>
        <button onclick="showManual()">Type Code Instead</button>
        
        <div id="camera-section" style="display: none;">
            <video id="video" playsinline></video>
            <canvas id="scan-canvas" style="display: none;"></canvas>
            <div style="text-align: center; font-size: 12px;">Point camera at computer screen</div>
        </div>
        
        <div id="manual-section" style="display: none; margin-top: 20px;">
            <div class="big-text">Paste computer's code:</div>
            <textarea id="offer-input" placeholder="Paste here..."></textarea>
            <button onclick="processOffer()">CONNECT</button>
        </div>
        
        <div id="response-section" style="display: none; margin-top: 30px; border-top: 1px solid #0f0; padding-top: 20px;">
            <div class="big-text">Show this to computer:</div>
            <canvas id="response-qr"></canvas>
            <div class="code-display" id="response-code" onclick="copyText(this)"></div>
        </div>
    </div>
</div>

<!-- GAME UI -->
<div id="game" style="display: none;">
    <div class="score">
        <div>YOU: <span id="me">0</span></div>
        <div>FOE: <span id="foe">0</span></div>
    </div>
    <div id="message">Choose your weapon!</div>
    
    <div class="choices" id="buttons">
        <button class="choice" onclick="shoot('rock')">✊</button>
        <button class="choice" onclick="shoot('paper')">✋</button>
        <button class="choice" onclick="shoot('scissors')">✌</button>
    </div>
    
    <div id="foe-choice">?</div>
    
    <button onclick="location.reload()" style="margin-top: 40px; font-size: 12px;">New Game</button>
</div>

<script>
let pc = null;
let channel = null;
let isHost = false;
let myMove = null;
let foeMove = null;
let myScore = 0;
let foeScore = 0;

// HOST
async function becomeHost() {
    isHost = true;
    document.getElementById('host-panel').classList.add('active');
    updateStatus('Creating secure channel...');
    
    try {
        pc = new RTCPeerConnection({
            iceServers: [{ urls: 'stun:stun.l.google.com:19302' }]
        });
        
        channel = pc.createDataChannel('ghost');
        setupDataChannel(channel);
        
        const offer = await pc.createOffer();
        await pc.setLocalDescription(offer);
        
        // Wait for ICE or timeout
        setTimeout(() => {
            const code = btoa(JSON.stringify(pc.localDescription));
            showHostCode(code);
        }, 1000);
        
    } catch(e) {
        alert('Error: ' + e.message);
        console.error(e);
    }
}

function showHostCode(code) {
    document.getElementById('host-code').textContent = code;
    updateStatus('Code ready! Scan or copy.');
    
    // Try to make QR
    try {
        const canvas = document.getElementById('qrcanvas');
        QRCode.toCanvas(canvas, code, { width: 300, margin: 2 }, function(error) {
            if (error) {
                console.error('QR Error:', error);
                document.getElementById('qr-fallback').style.display = 'block';
                canvas.style.display = 'none';
            } else {
                updateStatus('QR Code ready!');
            }
        });
    } catch(e) {
        document.getElementById('qr-fallback').style.display = 'block';
        console.error('QR Exception:', e);
    }
}

function completeHost() {
    const answer = document.getElementById('answer-receive').value.trim();
    if (!answer) return alert('Paste the response from phone!');
    
    try {
        const desc = JSON.parse(atob(answer));
        pc.setRemoteDescription(desc);
        startGame();
    } catch(e) {
        alert('Invalid code: ' + e.message);
    }
}

// JOINER
function becomeJoiner() {
    document.getElementById('joiner-panel').classList.add('active');
}

function showManual() {
    document.getElementById('manual-section').style.display = 'block';
    document.getElementById('camera-section').style.display = 'none';
}

async function startCamera() {
    document.getElementById('camera-section').style.display = 'block';
    document.getElementById('manual-section').style.display = 'none';
    
    const video = document.getElementById('video');
    try {
        const stream = await navigator.mediaDevices.getUserMedia({ video: { facingMode: 'environment' } });
        video.srcObject = stream;
        video.play();
        scanFrame();
    } catch(e) {
        alert('Camera failed. Use manual input.');
        showManual();
    }
}

function scanFrame() {
    const video = document.getElementById('video');
    const canvas = document.getElementById('scan-canvas');
    const ctx = canvas.getContext('2d');
    
    if (video.readyState === video.HAVE_ENOUGH_DATA) {
        canvas.width = video.videoWidth;
        canvas.height = video.videoHeight;
        ctx.drawImage(video, 0, 0, canvas.width, canvas.height);
        const imgData = ctx.getImageData(0, 0, canvas.width, canvas.height);
        const code = jsQR(imgData.data, imgData.width, imgData.height);
        
        if (code) {
            handleOfferData(code.data);
            return;
        }
    }
    requestAnimationFrame(scanFrame);
}

function processOffer() {
    const data = document.getElementById('offer-input').value.trim();
    if (data) handleOfferData(data);
}

async function handleOfferData(offerStr) {
    try {
        const offer = JSON.parse(atob(offerStr));
        pc = new RTCPeerConnection({
            iceServers: [{ urls: 'stun:stun.l.google.com:19302' }]
        });
        
        pc.ondatachannel = (e) => {
            channel = e.channel;
            setupDataChannel(channel);
        };
        
        await pc.setRemoteDescription(offer);
        const answer = await pc.createAnswer();
        await pc.setLocalDescription(answer);
        
        setTimeout(() => {
            const code = btoa(JSON.stringify(pc.localDescription));
            showResponse(code);
        }, 1000);
        
    } catch(e) {
        alert('Error: ' + e.message);
    }
}

function showResponse(code) {
    document.getElementById('response-section').style.display = 'block';
    document.getElementById('response-code').textContent = code;
    
    try {
        QRCode.toCanvas(document.getElementById('response-qr'), code, { width: 250 });
    } catch(e) {
        console.log('QR skipped');
    }
    
    updateStatus('Show this code to computer!');
}

// GAME LOGIC
function setupDataChannel(dc) {
    dc.onopen = () => {
        updateStatus('CONNECTED!');
        setTimeout(startGame, 500);
    };
    dc.onmessage = (e) => {
        const data = JSON.parse(e.data);
        if (data.move) {
            foeMove = data.move;
            resolveRound();
        }
    };
}

function startGame() {
    document.getElementById('setup').style.display = 'none';
    document.getElementById('game').style.display = 'block';
}

function shoot(move) {
    if (myMove) return;
    myMove = move;
    
    // Visuals
    const buttons = document.querySelectorAll('.choice');
    buttons.forEach(b => b.disabled = true);
    event.target.classList.add('picked');
    document.getElementById('message').textContent = 'Waiting for foe...';
    
    // Send
    if (channel && channel.readyState === 'open') {
        channel.send(JSON.stringify({ move: move }));
    }
    
    if (foeMove) resolveRound();
}

function resolveRound() {
    if (!myMove || !foeMove) return;
    
    const msg = document.getElementById('message');
    const foeDisplay = document.getElementById('foe-choice');
    
    foeDisplay.textContent = foeMove === 'rock' ? '✊' : foeMove === 'paper' ? '✋' : '✌';
    foeDisplay.style.opacity = '1';
    
    // Determine winner
    if (myMove === foeMove) {
        msg.textContent = 'DRAW!';
        msg.style.color = '#ff0';
    } else if (
        (myMove === 'rock' && foeMove === 'scissors') ||
        (myMove === 'paper' && foeMove === 'rock') ||
        (myMove === 'scissors' && foeMove === 'paper')
    ) {
        myScore++;
        msg.textContent = 'YOU WIN!';
        msg.style.color = '#0f0';
    } else {
        foeScore++;
        msg.textContent = 'YOU LOSE!';
        msg.style.color = '#f00';
    }
    
    document.getElementById('me').textContent = myScore;
    document.getElementById('foe').textContent = foeScore;
    
    // Reset after 2 seconds
    setTimeout(() => {
        myMove = null;
        foeMove = null;
        document.querySelectorAll('.choice').forEach(b => {
            b.disabled = false;
            b.classList.remove('picked');
        });
        foeDisplay.textContent = '?';
        foeDisplay.style.opacity = '0.3';
        msg.textContent = 'Choose!';
        msg.style.color = '#0f0';
    }, 2000);
}

function copyText(el) {
    navigator.clipboard.writeText(el.textContent).then(() => {
        const old = el.textContent;
        el.textContent = 'COPIED!';
        setTimeout(() => el.textContent = old, 1000);
    });
}

function updateStatus(txt) {
    console.log(txt);
}
</script>

</body>
</html>
