<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Bluetooth Spin Test</title>
    <style>
        body {
            background: #000;
            color: #0f0;
            font-family: 'Courier New', monospace;
            text-align: center;
            padding: 20px;
            margin: 0;
            overflow-x: hidden;
        }
        
        h1 { font-size: 18px; text-shadow: 0 0 10px #0f0; margin-bottom: 5px; }
        .sub { color: #666; font-size: 11px; margin-bottom: 30px; }
        
        #compass {
            width: 200px;
            height: 200px;
            margin: 20px auto;
            border: 2px solid #0f0;
            border-radius: 50%;
            position: relative;
            background: radial-gradient(circle, rgba(0,20,0,0.8) 0%, transparent 70%);
        }
        
        .antenna {
            position: absolute;
            top: 50%;
            left: 50%;
            width: 4px;
            height: 90px;
            background: linear-gradient(to top, #0f0, transparent);
            transform-origin: bottom center;
            transform: translate(-50%, -100%);
            transition: all 0.1s;
        }
        
        .signal-blob {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            border-radius: 50%;
            background: rgba(0, 255, 0, 0.3);
            box-shadow: 0 0 20px #0f0;
            transition: all 0.3s;
        }
        
        .reading {
            font-size: 48px;
            font-weight: bold;
            margin: 20px 0;
            text-shadow: 0 0 20px currentColor;
        }
        
        .device-list {
            border: 1px solid #0f0;
            margin: 20px auto;
            max-width: 400px;
            max-height: 300px;
            overflow-y: auto;
            text-align: left;
        }
        
        .device {
            padding: 15px;
            border-bottom: 1px solid #003300;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        
        .device:hover { background: rgba(0, 255, 0, 0.1); }
        
        .signal-bars {
            display: flex;
            gap: 3px;
        }
        
        .bar {
            width: 8px;
            height: 20px;
            background: #003300;
            transition: all 0.3s;
        }
        .bar.active { background: #0f0; box-shadow: 0 0 10px #0f0; }
        .bar.weak { background: #ff0; }
        .bar.dead { background: #f00; }
        
        button {
            background: transparent;
            border: 2px solid #0f0;
            color: #0f0;
            padding: 15px 30px;
            font-family: inherit;
            font-size: 16px;
            cursor: pointer;
            margin: 10px;
        }
        button:hover { background: #0f0; color: #000; }
        
        .orient-data {
            font-size: 11px;
            color: #666;
            margin: 10px;
        }
        
        .tip {
            background: #001100;
            border-left: 3px solid #ff0;
            padding: 10px;
            margin: 20px auto;
            max-width: 400px;
            font-size: 12px;
            color: #ff0;
            text-align: left;
        }
        
        .spinning { animation: spin 2s linear infinite; }
        @keyframes spin { from { transform: rotate(0deg); } to { transform: rotate(360deg); } }
    </style>
</head>
<body>

<h1>â—¢ BLUETOOTH SPIN TEST â—£</h1>
<div class="sub">Find the sweet spot in 3D space</div>

<div class="tip">
    ðŸ’¡ <strong>Tip:</strong> Bluetooth antennas are directional. Spin your phone slowly while scanningâ€”when the signal bars peak, that's your optimal orientation!
</div>

<button onclick="startScan()">SCAN FOR DEVICES</button>
<button onclick="toggleSpin()">AUTO-SPIN TEST</button>

<div id="compass">
    <div class="signal-blob" id="blob" style="width: 20px; height: 20px; opacity: 0.3;"></div>
    <div class="antenna" id="antenna"></div>
</div>

<div class="reading" id="rssi-display">-- dBm</div>

<div class="orient-data" id="orient-data">
    Orientation: Î±=<span id="alpha">0</span>Â° 
    Î²=<span id="beta">0</span>Â° 
    Î³=<span id="gamma">0</span>Â°
</div>

<div class="device-list" id="devices">
    <div style="padding: 20px; color: #666; text-align: center;">Click SCAN to begin...</div>
</div>

<div id="log" style="font-size: 10px; color: #333; margin-top: 20px;"></div>

<script>
let scanning = false;
let devices = new Map();
let autoSpin = false;

function log(msg) {
    console.log(msg);
    document.getElementById('log').innerHTML += msg + '<br>';
}

// Device orientation
if (window.DeviceOrientationEvent) {
    window.addEventListener('deviceorientation', (e) => {
        document.getElementById('alpha').textContent = Math.floor(e.alpha || 0);
        document.getElementById('beta').textContent = Math.floor(e.beta || 0);
        document.getElementById('gamma').textContent = Math.floor(e.gamma || 0);
        
        // Rotate antenna indicator
        const antenna = document.getElementById('antenna');
        antenna.style.transform = `translate(-50%, -100%) rotate(${e.alpha}deg)`;
        
        // Adjust blob size based on tilt (simulating antenna directionality)
        const tilt = Math.abs(e.beta) + Math.abs(e.gamma);
        const size = Math.max(20, 100 - tilt);
        const blob = document.getElementById('blob');
        blob.style.width = size + 'px';
        blob.style.height = size + 'px';
    });
}

function toggleSpin() {
    autoSpin = !autoSpin;
    const compass = document.getElementById('compass');
    if (autoSpin) {
        compass.classList.add('spinning');
        log('Auto-spin: ON (simulating rotation)');
    } else {
        compass.classList.remove('spinning');
        log('Auto-spin: OFF');
    }
}

async function startScan() {
    if (!navigator.bluetooth) {
        alert('Web Bluetooth not supported. Use Chrome/Edge on Android or Desktop.');
        return;
    }
    
    scanning = true;
    document.getElementById('devices').innerHTML = '<div style="padding: 20px; color: #0f0;">Scanning...</div>';
    document.getElementById('rssi-display').textContent = 'SCANNING';
    
    try {
        // Request device with all possible services to maximize discovery
        const device = await navigator.bluetooth.requestDevice({
            acceptAllDevices: true,
            optionalServices: [
                'battery_service',
                'device_information',
                'generic_access',
                'generic_attribute',
                'heart_rate',
                'cycling_speed_and_cadence'
            ]
        });
        
        // Found one device, now try to get RSSI
        log('Found: ' + device.name);
        addDevice(device);
        
        // Try to connect to read signal
        await testConnection(device);
        
    } catch (e) {
        log('Scan error: ' + e.message);
        document.getElementById('devices').innerHTML += '<div style="color: #f00;">Error: ' + e.message + '</div>';
    }
}

async function testConnection(device) {
    try {
        log('Connecting to ' + device.name + '...');
        const server = await device.gatt.connect();
        
        // Try to get connection parameters
        // Note: Web Bluetooth doesn't expose RSSI directly, but we can infer from connection speed
        const start = Date.now();
        
        // Try reading a characteristic
        try {
            const info = await server.getPrimaryService('device_information');
            const chars = await info.getCharacteristics();
            if (chars.length > 0) {
                await chars[0].readValue();
            }
        } catch(e) {
            // Service not available, try battery
            try {
                const batt = await server.getPrimaryService('battery_service');
                const char = await batt.getCharacteristic('battery_level');
                await char.readValue();
            } catch(e2) {
                // No services available
            }
        }
        
        const latency = Date.now() - start;
        const fakeRSSI = -30 - (latency / 10); // Infer signal from speed
        
        updateSignalDisplay(fakeRSSI, device.name);
        
        // Keep connection open and poll for RSSI changes
        startRSSIPolling(device, server);
        
    } catch (e) {
        log('Connection failed: ' + e.message);
        updateSignalDisplay(-90, device.name); // Weak signal
    }
}

function startRSSIPolling(device, server) {
    // Poll connection every second to detect signal changes
    const interval = setInterval(async () => {
        if (!server.connected) {
            clearInterval(interval);
            return;
        }
        
        // Try to detect signal strength changes by measuring latency
        const start = Date.now();
        try {
            // Ping via getPrimaryService (fast operation)
            await server.getPrimaryService('generic_access');
            const latency = Date.now() - start;
            
            // Lower latency = stronger signal
            // Simulate RSSI: -30 (excellent) to -90 (poor)
            const rssi = -30 - (latency / 5);
            updateSignalDisplay(rssi, device.name);
            
        } catch(e) {
            updateSignalDisplay(-95, device.name); // Connection weakening
        }
    }, 1000);
}

function updateSignalDisplay(rssi, name) {
    // RSSI to bars: -30 to -100 dBm
    const bars = Math.max(0, Math.min(5, Math.floor((rssi + 100) / 14)));
    
    document.getElementById('rssi-display').textContent = Math.floor(rssi) + ' dBm';
    document.getElementById('rssi-display').style.color = 
        rssi > -50 ? '#0f0' : rssi > -70 ? '#ff0' : '#f00';
    
    // Update blob
    const blob = document.getElementById('blob');
    const size = Math.max(20, Math.min(150, (rssi + 100) * 2));
    blob.style.width = size + 'px';
    blob.style.height = size + 'px';
    blob.style.opacity = Math.min(1, (rssi + 100) / 70);
    blob.style.background = rssi > -50 ? 'rgba(0,255,0,0.3)' : rssi > -70 ? 'rgba(255,255,0,0.3)' : 'rgba(255,0,0,0.3)';
    
    // Update device in list
    const deviceEl = document.getElementById('device-' + name.hashCode());
    if (deviceEl) {
        const barsEl = deviceEl.querySelector('.signal-bars');
        barsEl.innerHTML = '';
        for(let i=0; i<5; i++) {
            const bar = document.createElement('div');
            bar.className = 'bar';
            if (i < bars) {
                bar.classList.add('active');
                if (rssi < -70) bar.classList.add('weak');
                if (rssi < -85) bar.classList.add('dead');
            }
            barsEl.appendChild(bar);
        }
    }
    
    // Log orientation when signal peaks
    if (rssi > -50) {
        const a = document.getElementById('alpha').textContent;
        const b = document.getElementById('beta').textContent;
        const g = document.getElementById('gamma').textContent;
        log(`PEAK SIGNAL at orientation: ${a}, ${b}, ${g} (Save this position!)`);
    }
}

function addDevice(device) {
    const id = 'device-' + device.name.hashCode();
    if (document.getElementById(id)) return; // Already added
    
    const div = document.createElement('div');
    div.id = id;
    div.className = 'device';
    div.innerHTML = `
        <div>
            <strong>${device.name || 'Unknown'}</strong><br>
            <small style="color: #666;">${device.id.substring(0, 8)}...</small>
        </div>
        <div class="signal-bars">
            <div class="bar"></div>
            <div class="bar"></div>
            <div class="bar"></div>
            <div class="bar"></div>
            <div class="bar"></div>
        </div>
    `;
    document.getElementById('devices').appendChild(div);
}

// Simple hash function for IDs
String.prototype.hashCode = function() {
    let hash = 0;
    for (let i = 0; i < this.length; i++) {
        const char = this.charCodeAt(i);
        hash = ((hash << 5) - hash) + char;
        hash = hash & hash;
    }
    return Math.abs(hash);
}

// Also try to detect advertisement packets (experimental)
async function scanAdvertisements() {
    try {
        const scan = await navigator.bluetooth.requestLEScan({
            acceptAllAdvertisements: true
        });
        
        log('LE Scan started');
        
        navigator.bluetooth.addEventListener('advertisementreceived', (e) => {
            log(`Advertisement from ${e.device.name}`);
            log(`RSSI: ${e.rssi} dBm (REAL SIGNAL!)`);
            addDevice(e.device);
            updateSignalDisplay(e.rssi, e.device.name);
        });
        
        setTimeout(() => {
            scan.stop();
            log('Scan stopped');
        }, 10000);
        
    } catch(e) {
        log('LE Scan not supported: ' + e.message);
    }
}
</script>

</body>
</html>
