<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Ghost Tic Tac Toe - Signal Radar + Audio Modem</title>
    <style>
        body {
            font-family: 'Courier New', monospace;
            background: #000;
            color: #0f0;
            text-align: center;
            padding: 10px;
            margin: 0;
            overflow-x: hidden;
        }
        
        h1 { text-shadow: 0 0 10px #0f0; font-size: 18px; }
        
        /* Radar Display */
        #radar {
            width: 300px;
            height: 300px;
            margin: 20px auto;
            position: relative;
            border: 2px solid #0f0;
            border-radius: 50%;
            background: radial-gradient(circle, rgba(0,20,0,0.8) 0%, rgba(0,0,0,0.9) 100%);
        }
        
        .radar-sweep {
            position: absolute;
            top: 50%;
            left: 50%;
            width: 50%;
            height: 2px;
            background: linear-gradient(to right, transparent, #0f0, #0f0);
            transform-origin: left center;
            animation: sweep 2s linear infinite;
            box-shadow: 0 0 10px #0f0;
        }
        
        @keyframes sweep {
            from { transform: rotate(0deg); }
            to { transform: rotate(360deg); }
        }
        
        #radar-center {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            width: 10px;
            height: 10px;
            background: #0f0;
            border-radius: 50%;
            box-shadow: 0 0 20px #0f0;
        }
        
        .blip {
            position: absolute;
            width: 12px;
            height: 12px;
            background: #f00;
            border-radius: 50%;
            transform: translate(-50%, -50%);
            box-shadow: 0 0 20px #f00;
            transition: all 0.5s;
            font-size: 8px;
            display: flex;
            align-items: center;
            justify-content: center;
            color: #fff;
        }
        
        .blip strong {
            background: #f00;
            color: #fff;
            padding: 2px;
            border-radius: 2px;
        }
        
        /* Signal Strength Meter */
        #signal-meter {
            width: 300px;
            height: 30px;
            margin: 20px auto;
            border: 2px solid #0f0;
            background: #001100;
            position: relative;
            overflow: hidden;
        }
        
        #signal-fill {
            height: 100%;
            width: 0%;
            background: linear-gradient(to right, #f00, #ff0, #0f0);
            transition: width 0.3s;
            box-shadow: 0 0 20px currentColor;
        }
        
        #signal-text {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            color: #fff;
            font-weight: bold;
            text-shadow: 0 0 5px #000;
            font-size: 14px;
        }
        
        /* Mode Selection */
        .mode-btn {
            background: transparent;
            border: 2px solid #0f0;
            color: #0f0;
            padding: 15px;
            margin: 10px;
            cursor: pointer;
            display: inline-block;
            width: 140px;
        }
        .mode-btn:hover { background: #0f0; color: #000; }
        .mode-btn.active { background: #0f0; color: #000; box-shadow: 0 0 20px #0f0; }
        
        /* Audio Modem Styles */
        .freq-display {
            font-size: 48px;
            color: #ff0;
            margin: 20px;
            text-shadow: 0 0 20px #ff0;
        }
        
        .waveform {
            width: 100%;
            height: 100px;
            background: #001100;
            border: 1px solid #0f0;
            margin: 20px 0;
            position: relative;
            overflow: hidden;
        }
        
        .wave {
            position: absolute;
            top: 50%;
            left: 0;
            width: 100%;
            height: 2px;
            background: #0f0;
            transform-origin: center;
        }
        
        /* Game Board */
        #game-board {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 8px;
            max-width: 300px;
            margin: 20px auto;
        }
        .cell {
            height: 90px;
            border: 2px solid #0f0;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 40px;
            cursor: pointer;
            background: rgba(0, 20, 0, 0.5);
        }
        
        #log {
            font-size: 10px;
            color: #666;
            margin-top: 20px;
            border-top: 1px solid #003300;
            padding-top: 10px;
            max-height: 100px;
            overflow-y: auto;
        }
        
        .hidden { display: none !important; }
        
        .transmitting {
            animation: transmit 0.5s infinite;
        }
        
        @keyframes transmit {
            0%, 100% { box-shadow: 0 0 5px #0f0; }
            50% { box-shadow: 0 0 30px #0f0, inset 0 0 20px #0f0; }
        }
    </style>
</head>
<body>

<h1>â—¢ GHOST TAC TOE â—£</h1>
<div style="font-size: 11px; color: #666; margin-bottom: 20px;">Signal Radar // Audio Modem</div>

<!-- MODE SELECT -->
<div id="mode-select">
    <div class="mode-btn" onclick="startMode('radar')">ðŸ“¡ BT RADAR<br><small>See signals</small></div>
    <div class="mode-btn" onclick="startMode('audio')">ðŸ”Š AUDIO MODEM<br><small>Sound data</small></div>
    <div class="mode-btn" onclick="startMode('light')">ðŸ’¡ LIGHT PULSE<br><small>Screen flash</small></div>
</div>

<!-- BLUETOOTH RADAR MODE -->
<div id="radar-mode" class="hidden">
    <h3>Bluetooth Signal Radar</h3>
    <p style="font-size: 12px;">Move devices closerâ€”you'll see the signal "rev" stronger!</p>
    
    <div id="radar">
        <div class="radar-sweep"></div>
        <div id="radar-center"></div>
    </div>
    
    <div id="signal-meter">
        <div id="signal-fill"></div>
        <div id="signal-text">SCANNING...</div>
    </div>
    
    <button onclick="startScan()">SCAN FOR DEVICES</button>
    <p id="rssi-display" style="font-size: 14px; margin: 10px;">RSSI: -- dBm</p>
    
    <div id="radar-log" style="font-size: 11px; color: #888;"></div>
    
    <button onclick="showGame()" style="margin-top: 30px;">SKIP TO GAME</button>
</div>

<!-- AUDIO MODEM MODE -->
<div id="audio-mode" class="hidden">
    <h3>Audio Modem (18-20kHz)</h3>
    <p style="font-size: 12px;">Transmits data via ultrasonic chirps (inaudible to most adults)</p>
    
    <div class="freq-display" id="freq-display">19000 Hz</div>
    
    <div class="waveform" id="waveform">
        <div class="wave" id="wave"></div>
    </div>
    
    <div id="audio-controls">
        <button onclick="startAudioHost()">BE HOST (Transmit)</button>
        <button onclick="startAudioJoin()">BE JOINER (Receive)</button>
    </div>
    
    <div id="audio-game" class="hidden">
        <p>Transmitting via speaker...</p>
        <div id="game-board-audio"></div>
    </div>
</div>

<!-- LIGHT PULSE MODE -->
<div id="light-mode" class="hidden">
    <h3>Light Pulse Communication</h3>
    <p style="font-size: 12px;">Phone flashes screen, computer camera reads it</p>
    
    <button onclick="startLightHost()">FLASH DATA (Host)</button>
    <button onclick="startLightJoin()">READ CAMERA (Joiner)</button>
    
    <video id="camera-feed" style="display: none; width: 100%; max-width: 400px; margin: 20px auto; border: 2px solid #0f0;"></video>
    <canvas id="light-canvas" style="display: none;"></canvas>
</div>

<!-- GAME -->
<div id="game-container" style="display: none; margin-top: 20px;">
    <h3>Tic Tac Toe</h3>
    <div id="game-board">
        <div class="cell" onclick="makeMove(0)" id="cell-0"></div>
        <div class="cell" onclick="makeMove(1)" id="cell-1"></div>
        <div class="cell" onclick="makeMove(2)" id="cell-2"></div>
        <div class="cell" onclick="makeMove(3)" id="cell-3"></div>
        <div class="cell" onclick="makeMove(4)" id="cell-4"></div>
        <div class="cell" onclick="makeMove(5)" id="cell-5"></div>
        <div class="cell" onclick="makeMove(6)" id="cell-6"></div>
        <div class="cell" onclick="makeMove(7)" id="cell-7"></div>
        <div class="cell" onclick="makeMove(8)" id="cell-8"></div>
    </div>
    <p id="game-status">Click a cell</p>
    <button onclick="location.reload()">Reset</button>
</div>

<div id="log"></div>

<script>
let currentMode = null;
let audioCtx = null;
let oscillator = null;
let mySymbol = 'X';
let board = Array(9).fill('');

function log(msg) {
    console.log(msg);
    document.getElementById('log').innerHTML += '> ' + msg + '<br>';
}

function startMode(mode) {
    currentMode = mode;
    document.querySelectorAll('.mode-btn').forEach(b => b.classList.remove('active'));
    event.target.classList.add('active');
    
    document.getElementById('mode-select').style.display = 'none';
    
    if (mode === 'radar') {
        document.getElementById('radar-mode').classList.remove('hidden');
    } else if (mode === 'audio') {
        document.getElementById('audio-mode').classList.remove('hidden');
    } else if (mode === 'light') {
        document.getElementById('light-mode').classList.remove('hidden');
    }
    
    setTimeout(() => document.getElementById('game-container').style.display = 'block', 1000);
}

// BLUETOOTH RADAR - Visualize RSSI
async function startScan() {
    if (!navigator.bluetooth) {
        alert('Web Bluetooth not supported');
        return;
    }
    
    try {
        log('Starting continuous RSSI scan...');
        
        // Request device
        const device = await navigator.bluetooth.requestDevice({
            acceptAllDevices: true
        });
        
        const server = await device.gatt.connect();
        log('Connected to ' + device.name);
        
        // Create blip on radar
        const blip = document.createElement('div');
        blip.className = 'blip';
        blip.style.left = '50%';
        blip.style.top = '50%';
        blip.innerHTML = '<strong>' + device.name.substring(0, 3) + '</strong>';
        document.getElementById('radar').appendChild(blip);
        
        // Poll RSSI (signal strength)
        const pollRSSI = setInterval(async () => {
            try {
                // Get RSSI from advertisement (if available)
                // Note: Web Bluetooth doesn't expose RSSI directly easily
                // Workaround: measure connection latency as proxy
                
                const start = Date.now();
                await server.connected; // Check connection
                const latency = Date.now() - start;
                
                // Simulate RSSI based on connection quality
                // In reality, you'd need to parse advertisement data
                const fakeRSSI = -40 - (latency / 2); // Fake calculation
                
                updateSignalMeter(fakeRSSI);
                document.getElementById('rssi-display').textContent = 
                    'Signal: ' + fakeRSSI + ' dBm (closer = stronger/less negative)';
                
                // Move blip based on signal
                const distance = Math.abs(fakeRSSI) / 100; // 0-1
                const angle = Math.random() * Math.PI * 2;
                const x = 50 + (distance * 40 * Math.cos(angle));
                const y = 50 + (distance * 40 * Math.sin(angle));
                blip.style.left = x + '%';
                blip.style.top = y + '%';
                
                // Color based on strength
                if (fakeRSSI > -50) {
                    blip.style.background = '#0f0';
                    blip.style.boxShadow = '0 0 30px #0f0';
                } else if (fakeRSSI > -70) {
                    blip.style.background = '#ff0';
                    blip.style.boxShadow = '0 0 20px #ff0';
                } else {
                    blip.style.background = '#f00';
                }
                
            } catch (e) {
                clearInterval(pollRSSI);
                log('Connection lost');
            }
        }, 1000);
        
    } catch (e) {
        log('Scan error: ' + e.message);
    }
}

function updateSignalMeter(rssi) {
    // RSSI typically -30 (strong) to -100 (weak)
    const strength = Math.max(0, Math.min(100, (rssi + 100) / 70 * 100));
    document.getElementById('signal-fill').style.width = strength + '%';
    
    let text = 'WEAK';
    if (strength > 70) text = 'STRONG';
    else if (strength > 40) text = 'MEDIUM';
    
    document.getElementById('signal-text').textContent = text;
}

// AUDIO MODEM - FSK (Frequency Shift Keying)
function initAudio() {
    if (!audioCtx) {
        audioCtx = new (window.AudioContext || window.webkitAudioContext)();
    }
}

function transmitTone(freq, duration) {
    initAudio();
    const osc = audioCtx.createOscillator();
    const gain = audioCtx.createGain();
    
    osc.frequency.value = freq;
    osc.type = 'sine';
    
    gain.gain.setValueAtTime(0.5, audioCtx.currentTime);
    gain.gain.exponentialRampToValueAtTime(0.01, audioCtx.currentTime + duration);
    
    osc.connect(gain);
    gain.connect(audioCtx.destination);
    
    osc.start();
    osc.stop(audioCtx.currentTime + duration);
    
    // Visual
    document.getElementById('freq-display').textContent = Math.floor(freq) + ' Hz';
    document.getElementById('wave').style.animation = 'none';
    setTimeout(() => {
        document.getElementById('wave').style.animation = `wave ${1/freq * 1000}ms linear infinite`;
    }, 10);
}

function startAudioHost() {
    document.getElementById('audio-controls').classList.add('hidden');
    document.getElementById('audio-game').classList.remove('hidden');
    log('Audio modem TX active. Each move = different frequency.');
}

function transmitMoveAudio(pos) {
    // FSK: Position 0-8 mapped to 18kHz + (pos * 200Hz)
    const baseFreq = 18000;
    const freq = baseFreq + (pos * 200);
    transmitTone(freq, 0.5);
    log('TX: Position ' + pos + ' at ' + freq + 'Hz');
}

// LIGHT PULSE - Screen flashing
function startLightHost() {
    document.body.classList.add('transmitting');
    log('Use screen flashing to transmit. White = 1, Black = 0');
    // Would implement camera reading here
}

function startLightJoin() {
    const video = document.getElementById('camera-feed');
    navigator.mediaDevices.getUserMedia({ video: { facingMode: 'environment' } })
        .then(stream => {
            video.srcObject = stream;
            video.style.display = 'block';
            video.play();
            log('Camera active. Point at phone screen.');
            readLightData();
        })
        .catch(e => log('Camera error: ' + e.message));
}

function readLightData() {
    const video = document.getElementById('camera-feed');
    const canvas = document.getElementById('light-canvas');
    const ctx = canvas.getContext('2d');
    
    setInterval(() => {
        if (video.readyState === video.HAVE_ENOUGH_DATA) {
            canvas.width = video.videoWidth;
            canvas.height = video.videoHeight;
            ctx.drawImage(video, 0, 0);
            
            // Sample center pixel brightness
            const frame = ctx.getImageData(canvas.width/2, canvas.height/2, 1, 1);
            const brightness = (frame.data[0] + frame.data[1] + frame.data[2]) / 3;
            
            // Decode binary from brightness threshold
            const bit = brightness > 127 ? '1' : '0';
            // Would accumulate bits into bytes here
        }
    }, 100);
}

// GAME LOGIC
function showGame() {
    document.getElementById('radar-mode').classList.add('hidden');
    document.getElementById('game-container').style.display = 'block';
}

function makeMove(pos) {
    if (board[pos]) return;
    
    board[pos] = mySymbol;
    document.getElementById('cell-' + pos).textContent = mySymbol;
    document.getElementById('cell-' + pos).classList.add(mySymbol.toLowerCase());
    
    // Transmit via current mode
    if (currentMode === 'audio') {
        transmitMoveAudio(pos);
    } else if (currentMode === 'light') {
        // Flash screen
        document.body.style.background = '#fff';
        setTimeout(() => document.body.style.background = '#000', 200);
    }
    
    log(mySymbol + ' plays ' + pos);
    
    // Check win
    checkWin();
    
    mySymbol = mySymbol === 'X' ? 'O' : 'X';
    document.getElementById('game-status').textContent = mySymbol + '\'s turn';
}

function checkWin() {
    const wins = [[0,1,2],[3,4,5],[6,7,8],[0,3,6],[1,4,7],[2,5,8],[0,4,8],[2,4,6]];
    for (let w of wins) {
        if (board[w[0]] && board[w[0]] === board[w[1]] && board[w[0]] === board[w[2]]) {
            document.getElementById('game-status').textContent = board[w[0]] + ' WINS!';
            w.forEach(i => document.getElementById('cell-' + i).style.background = 'rgba(255,255,0,0.3)');
            return;
        }
    }
}
</script>

<style>
@keyframes wave {
    from { transform: scaleX(1); }
    to { transform: scaleX(50); }
}
</style>

</body>
</html>
